@{
    ViewData["Title"] = "Your Tasks";
    var userId = ViewData["UserId"];
}

<div class="container mt-5">
    <div class="d-flex justify-content-between">
        <h2>Your Tasks</h2>
        <!-- Logout button -->
        <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>

    <!-- Add task input -->
    <div class="input-group mt-4">
        <input type="text" id="newTaskInput" class="form-control" placeholder="Enter a new task" data-bind="value: newTask">
        <button class="btn btn-success" data-bind="click: addTask">Add</button>
    </div>

    <!-- Tasks list -->
    <div id="tasksContainer" class="mt-4 row">
        <!-- Task Cards -->
        <div class="col-md-4 mb-4" data-bind="foreach: tasks">
            <div class="card">
                <div class="card-body">
                    <!-- Task Name with Strike-through when done -->
                    <h5 class="card-title" data-bind="text: taskName, css: { 'text-decoration-line-through': status() }"></h5>

                    <div class="d-flex justify-content-between">
                        <!-- Mark as Done Button -->
                        <button class="btn btn-sm me-2"
                                data-bind="click: function() { $parent.toggleTaskStatus($data) },
                   visible: status() === false">
                            Mark as Done
                        </button>

                        <button class="btn btn-warning btn-sm me-2"
                                data-bind="click: function() { $parent.toggleTaskStatus($data) },
                   visible: status() === true">
                            Mark as Undone
                        </button>

                        <!-- Checkmark -->
                        <span class="text-success" data-bind="visible: status()">
                            <i class="bi bi-check-circle"></i> Done
                        </span>

                        <!-- Delete Button -->
                        <button class="btn btn-danger btn-sm" data-bind="click: function() { $parent.deleteTask($data) }">Delete</button>

                        <!-- Update Button -->
                        <button class="btn btn-primary btn-sm" data-bind="click: function() { $parent.startEditTask($data) }">Edit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Section -->
<div id="editTaskSection" class="mt-4" data-bind="visible: isEditing">
    <h3>Edit Task</h3>
    <input type="text" class="form-control" placeholder="Edit task name" data-bind="value: editedTaskName">
    <button class="btn btn-primary mt-2" data-bind="click: updateTask">Save</button>
    <button class="btn btn-secondary mt-2" data-bind="click: cancelEdit">Cancel</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout.js"></script>
@* <script src="./js/TasksViewModel.js"></script> *@


 <script>

    // Knockout.js ViewModel to manage tasks
    function TaskViewModel() {
        var self = this;
        self.UserId = null;
        self.tasks = ko.observableArray([]); // Array to hold tasks
        self.newTask = ko.observable(""); // New task input value

        // Observables for editing tasks
        self.isEditing = ko.observable(false); // To control visibility of the edit section
        self.editedTaskId = ko.observable(null); // ID of the task being edited
        self.editedTaskName = ko.observable(""); // Edited task name

        // Fetch tasks for the user
        self.fetchTasks = function (userId) {
            fetch(`/Task/GetTasksByUserId/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        // Map the data into task objects with taskName, id, and status
                        self.tasks(data.map(task => ({
                            taskName: task.taskName,
                            id: task.id,
                            status: ko.observable(task.status || false) // Ensure status is an observable
                        })));
                    }
                })
                .catch(error => console.error("Error fetching tasks:", error));
        };
        // Start editing a task
        self.startEditTask = function (task) {
            self.isEditing(true);
            self.editedTaskId(task.id);
            self.editedTaskName(task.taskName);
        };

        // Cancel editing
        self.cancelEdit = function () {
            self.isEditing(false);
            self.editedTaskId(null);
            self.editedTaskName("");
        };

        // Update a task
        self.updateTask = function (task) {
            var taskId = self.editedTaskId();
            var updatedTaskName = self.editedTaskName().trim();
            if (taskId && updatedTaskName) {
                fetch(`/Task/UpdateTask/${taskId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id: taskId, taskName: updatedTaskName, userId: userId })
                })
                    .then(response => {
                        if (response.ok) {
                            // Update the task in the observable array

                            var taskToUpdate = self.tasks().find(task => task.id === taskId);
                            if (taskToUpdate) {
                                taskToUpdate.taskName = updatedTaskName;
                                self.fetchTasks(self.UserID);
                                // Notify Knockout about the update
                            }

                            // Clear editing state
                            self.cancelEdit();
                        } else {
                            alert("Error updating task.");
                        }
                    })
                    .catch(error => console.error("Error updating task:", error));
            } else {
                alert("Task name cannot be empty.");
            }

        };
        // Add a new task
        self.addTask = function () {
            var newTaskName = self.newTask().trim(); // Get the value of the new task
            if (newTaskName) {
                fetch(`/Task/PostTask/AddTasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskName: newTaskName, userId: userId })
                })
                    .then(response => response.json())
                    .then(data => {
                        var newTask = {
                            taskName: data.taskName,
                            id: data.id,
                            status: ko.observable(false) // Default status is false (not done)
                        };
                        self.tasks.push(newTask);
                        self.newTask(""); // Clear input
                    })
                    .catch(error => console.error('Error adding task:', error));
            } else {
                alert('Please enter a task.');
            }
        };

        // Toggle task status (Done/Undone)
        self.toggleTaskStatus = function (task) {
            fetch(`/Task/ToggleTaskStatus/toggle-status/${task.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" }
            })
                .then(response => {
                    if (response.ok) {
                        // Toggle status observable
                        task.status(!task.status());  // This will automatically trigger Knockout.js binding
                    } else {
                        alert("Failed to update task status.");
                    }
                })
                .catch(error => console.error("Error toggling task status:", error));
        };


        // Delete a task
        self.deleteTask = function (task) {
            fetch(`/Task/DeleteTask/${task.id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        self.tasks.remove(task);
                    } else {
                        alert('Error deleting task');
                    }
                })
                .catch(error => console.error('Error deleting task:', error));
        };

        // Initialize and load tasks
        self.init = function (userId) {
            self.UserID = userId;
            self.fetchTasks(userId);
        };
    }


    // Initialize ViewModel and bind to view
    var viewModel = new TaskViewModel();
    var userId = @ViewData["UserId"];  // Dynamically pass userId from ViewData
    viewModel.init(userId);  // Fetch tasks for the user
    ko.applyBindings(viewModel); // Apply Knockout.js bindings

    // Logout function
    function logout() {
        if (confirm("Are you sure you want to log out?")) {
            window.location.href = "/User/Login"; // Redirect to login page
        }
    }
</script>
 

